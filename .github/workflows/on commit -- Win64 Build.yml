name: on commit -- Win64 Build.yml

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

jobs:
  build_dev:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with: { dotnet-version: 10.0.x }

      - name: Run Publish Script
        shell: pwsh
        run: ./dotnet.publish.ps1 -Runtime "win-x64" -ConfigFilter "Debug"

      - name: Package Dev Build
        shell: pwsh
        run: |
          $shortSha = "${{ github.sha }}".Substring(0, 7)
          $zipName = "RemakeEngine-Dev-$shortSha.zip"
          Compress-Archive -Path "EngineBuild/win-x64-Debug/*" -DestinationPath $zipName
          "ZIP_NAME=$zipName" >> $env:GITHUB_ENV
          "TAG=dev-$shortSha" >> $env:GITHUB_ENV

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ env.TAG }}" "${{ env.ZIP_NAME }}" --title "Dev Build: ${{ env.TAG }}" --notes "Automated dev build for commit ${{ github.sha }}" --prerelease
